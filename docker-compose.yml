services:
  api:
    build: .
    container_name: tripscore-api
    user: "${TRIPSCORE_DOCKER_UID:-1000}:${TRIPSCORE_DOCKER_GID:-1000}"
    ports:
      - "${TRIPSCORE_WEB_PORT:-8001}:8000"
    env_file:
      - .env
    environment:
      - TRIPSCORE_CACHE_DIR=/app/.cache/tripscore
      - TRIPSCORE_LOG_LEVEL=INFO
      # Allow local frontends (e.g. http://localhost:8003) during development.
      - TRIPSCORE_CORS_ALLOW_LOCAL=1
    volumes:
      - ./.cache/tripscore:/app/.cache/tripscore
      - ./data:/app/data
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  tdx-daemon:
    build: .
    container_name: tripscore-tdx-daemon
    user: "${TRIPSCORE_DOCKER_UID:-1000}:${TRIPSCORE_DOCKER_GID:-1000}"
    env_file:
      - .env
    environment:
      - TRIPSCORE_CACHE_DIR=/app/.cache/tripscore
      # Keep requests stable (override in .env via TRIPSCORE_CONFIG_PATH or YAML if needed)
      - TRIPSCORE_LOG_LEVEL=INFO
    command:
      [
        "python",
        "scripts/tdx_daemon.py",
        "--cities",
        "all",
        "--dynamic-refresh",
        "--dynamic-interval-seconds",
        "${TRIPSCORE_TDX_DAEMON_DYNAMIC_INTERVAL_SECONDS:-3600}",
        "--cooldown-seconds",
        "${TRIPSCORE_TDX_DAEMON_COOLDOWN_SECONDS:-3600}",
        "--static-refresh-days",
        "${TRIPSCORE_TDX_DAEMON_STATIC_REFRESH_DAYS:-45}",
        "--global-max-rpm",
        "${TRIPSCORE_TDX_GLOBAL_MAX_RPM:-40}",
        "--global-cooldown-seconds",
        "${TRIPSCORE_TDX_GLOBAL_COOLDOWN_SECONDS:-1800}",
        "--sleep-seconds",
        "${TRIPSCORE_TDX_DAEMON_SLEEP_SECONDS:-6.0}",
        "--request-spacing-seconds",
        "${TRIPSCORE_TDX_REQUEST_SPACING_SECONDS:-0.6}",
        "--retry-max-attempts",
        "${TRIPSCORE_TDX_RETRY_MAX_ATTEMPTS:-2}",
        "--bulk-max-pages-per-call",
        "${TRIPSCORE_TDX_BULK_MAX_PAGES_PER_CALL:-1}",
        "--bulk-max-seconds-per-call",
        "${TRIPSCORE_TDX_BULK_MAX_SECONDS_PER_CALL:-8.0}",
        "--static-pages-per-run",
        "${TRIPSCORE_TDX_DAEMON_STATIC_PAGES_PER_RUN:-1}",
        "--static-seconds-per-run",
        "${TRIPSCORE_TDX_DAEMON_STATIC_SECONDS_PER_RUN:-8.0}",
      ]
    volumes:
      - ./.cache/tripscore:/app/.cache/tripscore
      - ./data:/app/data
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
