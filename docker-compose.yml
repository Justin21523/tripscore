services:
  api:
    build: .
    container_name: tripscore-api
    user: "${TRIPSCORE_DOCKER_UID:-1000}:${TRIPSCORE_DOCKER_GID:-1000}"
    ports:
      - "${TRIPSCORE_WEB_PORT:-8001}:8000"
    env_file:
      - .env
    environment:
      - TRIPSCORE_CACHE_DIR=/app/.cache/tripscore
      - TRIPSCORE_LOG_LEVEL=INFO
    volumes:
      - ./.cache/tripscore:/app/.cache/tripscore
      - ./data:/app/data
    restart: unless-stopped

  tdx-daemon:
    build: .
    container_name: tripscore-tdx-daemon
    user: "${TRIPSCORE_DOCKER_UID:-1000}:${TRIPSCORE_DOCKER_GID:-1000}"
    env_file:
      - .env
    environment:
      - TRIPSCORE_CACHE_DIR=/app/.cache/tripscore
      # Keep requests stable (override in .env via TRIPSCORE_CONFIG_PATH or YAML if needed)
      - TRIPSCORE_LOG_LEVEL=INFO
    command:
      [
        "python",
        "scripts/tdx_daemon.py",
        "--cities",
        "all",
        "--dynamic-refresh",
        "--dynamic-interval-seconds",
        "1800",
        "--cooldown-seconds",
        "1200",
        "--static-refresh-days",
        "30",
        "--sleep-seconds",
        "3.0",
        "--request-spacing-seconds",
        "0.2",
        "--retry-max-attempts",
        "3",
        "--bulk-max-pages-per-call",
        "1",
        "--bulk-max-seconds-per-call",
        "12.0",
        "--static-pages-per-run",
        "1",
        "--static-seconds-per-run",
        "12.0",
      ]
    volumes:
      - ./.cache/tripscore:/app/.cache/tripscore
      - ./data:/app/data
    restart: unless-stopped
