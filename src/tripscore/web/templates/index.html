<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TripScore</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <h1>TripScore</h1>
        <p class="subtitle">Explainable, rule-based destination recommendations</p>
      </div>
      <div class="toolbar">
        <button id="run-btn" type="button" class="btn btn-primary" title="Ctrl+Enter">Run</button>
        <label class="toggle" title="A">
          <input id="auto-run" type="checkbox" />
          Auto-run
        </label>
        <button id="reset-btn" type="button" class="btn" title="Ctrl+R">Reset</button>
        <button id="save-preset-btn" type="button" class="btn" title="Ctrl+S">Save Preset</button>
        <button id="delete-preset-btn" type="button" class="btn" title="Delete custom preset">
          Delete Preset
        </button>
        <button id="help-btn" type="button" class="btn" title="?">Shortcuts</button>
      </div>
    </header>

    <div class="statusbar">
      <div class="statusbar-inner">
        <span id="status" class="status">Ready.</span>
      </div>
    </div>

    <main class="workspace">
      <section class="panel panel-controls">
        <div class="panel-header">
          <h2>Control Panel</h2>
          <div class="panel-header-actions">
            <label class="toggle" title="M">
              <input id="pick-origin" type="checkbox" />
              Pick origin (map click)
            </label>
            <label class="toggle" title="K">
              <input id="keyboard-controls" type="checkbox" checked />
              Keyboard controls
            </label>
          </div>
        </div>

        <div class="brief-strip" id="brief-strip">
          <div class="brief-title">Brief</div>
          <div class="brief-items">
            <span id="brief-when" class="brief-item">When: —</span>
            <span id="brief-from" class="brief-item">From: —</span>
            <span id="brief-goal" class="brief-item">Goal: —</span>
            <span id="brief-topn" class="brief-item">Top N: —</span>
            <span id="brief-data" class="brief-item">Data: —</span>
            <span id="brief-cache" class="brief-item">Cache: —</span>
            <span id="brief-updated" class="brief-item">Updated: —</span>
          </div>
        </div>

        <details class="panel-callout" id="coverage-panel">
          <summary>Data coverage</summary>
          <div class="callout-body">
            <div id="coverage-summary" class="muted">Loading…</div>
            <div id="coverage-table" class="coverage-table"></div>
          </div>
        </details>

        <div class="stepper" role="tablist" aria-label="Guided setup steps">
          <button class="step-tab active" type="button" data-step="step-1" aria-selected="true">
            <span class="step-num">1</span> Trip
          </button>
          <button class="step-tab" type="button" data-step="step-2" aria-selected="false">
            <span class="step-num">2</span> Priorities
          </button>
          <button class="step-tab" type="button" data-step="step-3" aria-selected="false">
            <span class="step-num">3</span> Preferences
          </button>
          <button class="step-tab" type="button" data-step="step-4" aria-selected="false">
            <span class="step-num">4</span> Advanced
          </button>
        </div>

        <form id="query-form">
          <section id="step-1" class="step-section active" role="tabpanel" aria-label="Step 1: Trip">
            <div class="step-header">
              <div>
                <div class="step-title">Step 1 — Trip</div>
                <div class="step-subtitle">Set the time window and origin. Use the map or keyboard shortcuts.</div>
              </div>
              <div class="step-actions">
                <button type="button" class="btn btn-small" data-next-step="step-2">Next</button>
              </div>
            </div>

            <details open>
              <summary>Query</summary>
              <div class="section-body">
              <div class="row row-2">
                <label>
                  Preset
                  <select id="preset">
                    <option value="">Custom</option>
                  </select>
                </label>
                <label>
                  Preset description
                  <input id="preset-description" type="text" value="Custom" disabled />
                </label>
              </div>

              <div class="row">
                <label>
                  Origin lat
                  <input id="origin-lat" type="number" step="0.000001" value="25.0478" required />
                </label>
                <label>
                  Origin lon
                  <input id="origin-lon" type="number" step="0.000001" value="121.5170" required />
                </label>
                <label>
                  Move step (m)
                  <select id="move-step">
                    <option value="10">10</option>
                    <option value="50" selected>50</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                  </select>
                </label>
              </div>

              <div class="row row-2">
                <div class="dpad">
                  <button id="move-n" type="button" class="btn btn-small" title="W / ↑">▲</button>
                  <button id="move-w" type="button" class="btn btn-small" title="A / ←">◀</button>
                  <button id="move-e" type="button" class="btn btn-small" title="D / →">▶</button>
                  <button id="move-s" type="button" class="btn btn-small" title="S / ↓">▼</button>
                </div>
                <div class="rotate">
                  <label>
                    Heading (deg)
                    <input id="heading-deg" type="number" min="0" max="359" step="1" value="0" />
                  </label>
                  <div class="rotate-buttons">
                    <button id="rotate-left" type="button" class="btn btn-small" title="Q">⟲</button>
                    <button id="rotate-right" type="button" class="btn btn-small" title="E">⟳</button>
                    <button id="center-origin-btn" type="button" class="btn btn-small" title="C">
                      Center map
                    </button>
                  </div>
                </div>
              </div>

              <div class="row">
                <label>
                  Start (Asia/Taipei)
                  <input id="start" type="datetime-local" required />
                </label>
                <label>
                  End (Asia/Taipei)
                  <input id="end" type="datetime-local" required />
                </label>
                <label>
                  Quick window
                  <select id="quick-window">
                    <option value="">(none)</option>
                    <option value="2">+2h</option>
                    <option value="4" selected>+4h</option>
                    <option value="8">+8h</option>
                  </select>
                </label>
              </div>
              </div>
            </details>
          </section>

          <section id="step-2" class="step-section" role="tabpanel" aria-label="Step 2: Priorities">
            <div class="step-header">
              <div>
                <div class="step-title">Step 2 — Priorities</div>
                <div class="step-subtitle">Tune how the system balances accessibility, weather, and preferences.</div>
              </div>
              <div class="step-actions">
                <button id="mode-balanced" type="button" class="btn btn-small">Balanced</button>
                <button id="mode-rainy" type="button" class="btn btn-small">Rainy day</button>
                <button id="mode-family" type="button" class="btn btn-small">Family</button>
                <button type="button" class="btn btn-small" data-prev-step="step-1">Back</button>
                <button type="button" class="btn btn-small" data-next-step="step-3">Next</button>
              </div>
            </div>

            <details open>
              <summary>Scoring Weights</summary>
              <div class="section-body">
              <div class="row">
                <label>
                  Accessibility
                  <div class="slider">
                    <input id="w-accessibility" type="range" min="0" max="1" step="0.05" value="0.35" />
                    <div class="slider-meta"><span id="w-accessibility-label">—</span><span id="w-accessibility-value">0.35</span></div>
                  </div>
                </label>
                <label>
                  Weather
                  <div class="slider">
                    <input id="w-weather" type="range" min="0" max="1" step="0.05" value="0.3" />
                    <div class="slider-meta"><span id="w-weather-label">—</span><span id="w-weather-value">0.30</span></div>
                  </div>
                </label>
                <label>
                  Preferences
                  <div class="slider">
                    <input id="w-preference" type="range" min="0" max="1" step="0.05" value="0.2" />
                    <div class="slider-meta"><span id="w-preference-label">—</span><span id="w-preference-value">0.20</span></div>
                  </div>
                </label>
              </div>
              <div class="row row-2">
                <label>
                  Context
                  <div class="slider">
                    <input id="w-context" type="range" min="0" max="1" step="0.05" value="0.15" />
                    <div class="slider-meta"><span id="w-context-label">—</span><span id="w-context-value">0.15</span></div>
                  </div>
                </label>
                <label>
                  Top N
                  <input id="top-n" type="number" min="1" max="20" value="10" />
                </label>
              </div>
              </div>
            </details>
          </section>

          <section id="step-3" class="step-section" role="tabpanel" aria-label="Step 3: Preferences">
            <div class="step-header">
              <div>
                <div class="step-title">Step 3 — Preferences</div>
                <div class="step-subtitle">Express what you care about: indoor/outdoor, culture, food, crowds.</div>
              </div>
              <div class="step-actions">
                <button type="button" class="btn btn-small" data-prev-step="step-2">Back</button>
                <button type="button" class="btn btn-small" data-next-step="step-4">Next</button>
              </div>
            </div>

            <details open>
              <summary>Preferences</summary>
              <div class="section-body">
              <div class="row">
                <label>
                  Avoid rain
                  <div class="slider">
                    <input id="avoid-rain" type="range" min="0" max="1" step="0.05" value="0.7" />
                    <div class="slider-meta"><span id="avoid-rain-label">—</span><span id="avoid-rain-value">0.70</span></div>
                  </div>
                </label>
                <label>
                  Avoid crowds
                  <div class="slider">
                    <input id="avoid-crowds" type="range" min="0" max="1" step="0.05" value="0.7" />
                    <div class="slider-meta"><span id="avoid-crowds-label">—</span><span id="avoid-crowds-value">0.70</span></div>
                  </div>
                </label>
                <label>
                  Family-friendly
                  <div class="slider">
                    <input id="family-importance" type="range" min="0" max="1" step="0.05" value="0.3" />
                    <div class="slider-meta"><span id="family-importance-label">—</span><span id="family-importance-value">0.30</span></div>
                  </div>
                </label>
              </div>

              <div class="row">
                <label>
                  Indoor
                  <div class="slider">
                    <input id="tag-indoor" type="range" min="0" max="1" step="0.05" value="0.6" />
                    <div class="slider-meta"><span id="tag-indoor-label">—</span><span id="tag-indoor-value">0.60</span></div>
                  </div>
                </label>
                <label>
                  Outdoor
                  <div class="slider">
                    <input id="tag-outdoor" type="range" min="0" max="1" step="0.05" value="0.4" />
                    <div class="slider-meta"><span id="tag-outdoor-label">—</span><span id="tag-outdoor-value">0.40</span></div>
                  </div>
                </label>
                <label>
                  Culture
                  <div class="slider">
                    <input id="tag-culture" type="range" min="0" max="1" step="0.05" value="0.3" />
                    <div class="slider-meta"><span id="tag-culture-label">—</span><span id="tag-culture-value">0.30</span></div>
                  </div>
                </label>
              </div>
              <div class="row">
                <label>
                  Food
                  <div class="slider">
                    <input id="tag-food" type="range" min="0" max="1" step="0.05" value="0.2" />
                    <div class="slider-meta"><span id="tag-food-label">—</span><span id="tag-food-value">0.20</span></div>
                  </div>
                </label>
                <label>
                  Family-friendly
                  <div class="slider">
                    <input id="tag-family" type="range" min="0" max="1" step="0.05" value="0.4" />
                    <div class="slider-meta"><span id="tag-family-label">—</span><span id="tag-family-value">0.40</span></div>
                  </div>
                </label>
                <label>
                  Low crowd
                  <div class="slider">
                    <input id="tag-crowd" type="range" min="0" max="1" step="0.05" value="0.4" />
                    <div class="slider-meta"><span id="tag-crowd-label">—</span><span id="tag-crowd-value">0.40</span></div>
                  </div>
                </label>
              </div>

              <div class="row row-2">
                <label>
                  Required tags (comma-separated)
                  <input id="required-tags" type="text" placeholder="e.g., indoor, culture" list="catalog-tags" />
                </label>
                <label>
                  Excluded tags (comma-separated)
                  <input id="excluded-tags" type="text" placeholder="e.g., outdoor" list="catalog-tags" />
                </label>
              </div>
              </div>
            </details>
          </section>

          <section id="step-4" class="step-section" role="tabpanel" aria-label="Step 4: Advanced">
            <div class="step-header">
              <div>
                <div class="step-title">Step 4 — Advanced</div>
                <div class="step-subtitle">Optional knobs for calibration and debugging. Safe defaults are fine.</div>
              </div>
              <div class="step-actions">
                <button type="button" class="btn btn-small" data-prev-step="step-3">Back</button>
              </div>
            </div>

            <details>
              <summary>Advanced Tuning (per request)</summary>
              <div class="section-body" id="advanced-overrides">
              <p class="hint">
                These values override server defaults for this request only. (Backend validates and ignores unsafe keys.)
              </p>
              <label class="toggle">
                <input id="enable-overrides" type="checkbox" />
                Enable tuning overrides
              </label>

              <h4>Accessibility</h4>
              <div class="row">
                <label>Bus radius (m) <input id="acc-bus-radius" type="number" min="50" step="50" /></label>
                <label>Bus count cap <input id="acc-bus-cap" type="number" min="0" step="1" /></label>
                <label>Origin distance cap (m) <input id="acc-origin-cap" type="number" min="0" step="500" /></label>
              </div>
              <div class="row">
                <label>Bus weight <input id="acc-w-bus" type="number" min="0" step="0.05" /></label>
                <label>Metro weight <input id="acc-w-metro" type="number" min="0" step="0.05" /></label>
                <label>Bike weight <input id="acc-w-bike" type="number" min="0" step="0.05" /></label>
              </div>
              <div class="row row-2">
                <label>Blend: local transit <input id="acc-w-local" type="number" min="0" step="0.05" /></label>
                <label>Blend: origin proximity <input id="acc-w-origin" type="number" min="0" step="0.05" /></label>
              </div>

              <h4>Weather</h4>
              <div class="row">
                <label>Comfort min (°C) <input id="wx-comfort-min" type="number" step="0.5" /></label>
                <label>Comfort max (°C) <input id="wx-comfort-max" type="number" step="0.5" /></label>
                <label>Temp penalty scale (°C) <input id="wx-temp-scale" type="number" step="0.5" /></label>
              </div>
              <div class="row row-2">
                <label>Rain weight <input id="wx-w-rain" type="number" min="0" step="0.05" /></label>
                <label>Temp weight <input id="wx-w-temp" type="number" min="0" step="0.05" /></label>
              </div>
              <div class="row row-2">
                <label>Indoor rain multiplier <input id="wx-mult-indoor" type="number" step="0.05" /></label>
                <label>Outdoor rain multiplier <input id="wx-mult-outdoor" type="number" step="0.05" /></label>
              </div>

              <h4>Context</h4>
              <div class="row">
                <label>Weekend multiplier <input id="ctx-weekend-mult" type="number" step="0.05" /></label>
                <label>Parking risk weight <input id="ctx-parking-weight" type="number" min="0" max="1" step="0.05" /></label>
                <label>Family tag bonus <input id="ctx-family-bonus" type="number" min="0" max="1" step="0.05" /></label>
              </div>

              <h4>Parking</h4>
              <div class="row">
                <label>Parking radius (m) <input id="park-radius" type="number" step="50" /></label>
                <label>Lot cap <input id="park-lot-cap" type="number" step="1" /></label>
                <label>Spaces cap <input id="park-spaces-cap" type="number" step="10" /></label>
              </div>
              </div>
            </details>

            <details>
              <summary>Expert</summary>
              <div class="section-body">
              <p class="hint">
                Optional: paste a JSON object for <code>settings_overrides</code> (same validation rules as Advanced
                Tuning).
              </p>
              <label>
                settings_overrides (JSON)
                <textarea id="overrides-json" rows="6" spellcheck="false"></textarea>
              </label>
              <div class="row row-2">
                <button id="load-defaults-btn" type="button" class="btn">Load server defaults</button>
                <button id="copy-query-btn" type="button" class="btn">Copy request JSON</button>
              </div>
              </div>
            </details>
          </section>

          <button id="submit" type="submit" class="btn btn-primary">Recommend</button>
        </form>
      </section>

      <section class="panel panel-scene">
        <div class="panel-header">
          <h2>Scene</h2>
          <div class="panel-header-actions">
            <button id="clear-btn" type="button" class="btn btn-small" title="Clear markers">
              Clear
            </button>
            <button id="fit-btn" type="button" class="btn btn-small" title="Fit map to results">
              Fit
            </button>
            <label class="toggle" title="Show lines from origin">
              <input id="show-lines" type="checkbox" />
              Lines
            </label>
          </div>
        </div>
        <div id="map"></div>
        <p class="hint">Map tiles require internet access. Drag the origin marker or enable “Pick origin”.</p>
      </section>

      <section class="panel panel-inspector">
        <div class="panel-header">
          <h2>Results</h2>
          <div class="panel-header-actions">
            <button id="copy-selected-btn" type="button" class="btn btn-small">Copy selected</button>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Results panel">
          <button id="tab-results" class="tab active" type="button" role="tab" aria-selected="true">List</button>
          <button id="tab-details" class="tab" type="button" role="tab" aria-selected="false">Brief</button>
          <button id="tab-debug" class="tab" type="button" role="tab" aria-selected="false">Data</button>
        </div>

	        <div id="panel-results" class="tab-panel active" role="tabpanel" aria-labelledby="tab-results">
	          <div id="policy-summary" class="policy-summary"></div>
	          <div class="panel-subheader">
	            <input id="result-search" type="text" placeholder="Search results…" />
	            <select id="result-sort" title="Sort">
	              <option value="rank" selected>Rank</option>
	              <option value="score_desc">Score (desc)</option>
              <option value="score_asc">Score (asc)</option>
              <option value="name_asc">Name (A→Z)</option>
            </select>
          </div>
          <div class="panel-subheader">
            <input id="result-tags" type="text" placeholder="Filter tags (comma-separated)…" list="catalog-tags" />
            <input id="result-location" type="text" placeholder="Filter city/district…" list="catalog-locations" />
          </div>
          <div class="panel-subheader">
            <label class="inline-field">
              Min score
              <input id="result-min-score" type="number" min="0" max="1" step="0.05" value="0" />
            </label>
            <div id="result-count" class="muted-inline"></div>
          </div>
          <ol id="results" class="result-list"></ol>
          <p class="hint">Tip: press <kbd>1</kbd>…<kbd>9</kbd> to select by rank.</p>
        </div>

        <div id="panel-details" class="tab-panel" role="tabpanel" aria-labelledby="tab-details">
          <div id="inspector" class="inspector">
            <p class="hint">Select a result (or map marker) to inspect its score breakdown.</p>
          </div>
        </div>

        <div id="panel-debug" class="tab-panel" role="tabpanel" aria-labelledby="tab-debug">
          <div id="debug-meta" class="debug-meta"></div>
          <div id="debug-tdx" class="debug-meta"></div>
          <div class="debug-meta">
            <strong>TDX prefetch control</strong><br />
            <div class="row row-2" style="margin-top: 8px">
	              <label>
	                City
	                <input id="tdx-city" type="text" placeholder="e.g., Taipei" list="tdx-cities" />
	              </label>
              <label>
                Pace (sleep seconds)
                <input id="tdx-sleep" type="number" min="0" step="0.5" value="2" />
              </label>
            </div>
            <div class="row row-2">
              <label>
                Datasets per run (burst control)
                <input id="tdx-datasets-per-run" type="number" min="0" step="1" value="0" />
              </label>
              <label class="toggle" style="align-self: end">
                <input id="tdx-reset" type="checkbox" />
                Reset bulk files on start
              </label>
            </div>
            <div class="row row-2">
              <button id="tdx-start-btn" type="button" class="btn">Start / Resume</button>
              <button id="tdx-cancel-btn" type="button" class="btn">Cancel</button>
            </div>
            <div id="tdx-job-status" class="hint"></div>
          </div>
          <div class="debug-grid">
            <div>
              <div class="debug-title">Last response</div>
              <pre id="debug-response" class="debug-pre">{}</pre>
            </div>
            <div>
              <div class="debug-title">Selected item</div>
              <pre id="debug-selected" class="debug-pre">{}</pre>
            </div>
          </div>
        </div>
      </section>
    </main>

    <dialog id="help-modal" class="modal">
      <form method="dialog" class="modal-card">
        <div class="modal-header">
          <h2>Keyboard Shortcuts</h2>
          <button class="btn btn-small" value="cancel" type="submit">Close</button>
        </div>
        <div class="modal-body">
          <ul class="shortcut-list">
            <li><kbd>Ctrl</kbd> + <kbd>Enter</kbd>: Run</li>
            <li><kbd>A</kbd>: Toggle auto-run</li>
            <li><kbd>M</kbd>: Toggle “Pick origin”</li>
            <li><kbd>K</kbd>: Toggle keyboard controls</li>
            <li><kbd>W</kbd>/<kbd>A</kbd>/<kbd>S</kbd>/<kbd>D</kbd> or arrows: Move origin (step in meters)</li>
            <li><kbd>1</kbd>…<kbd>9</kbd>: Select result by rank</li>
            <li><kbd>[</kbd>/<kbd>]</kbd>: Decrease/increase step</li>
            <li><kbd>Q</kbd>/<kbd>E</kbd>: Rotate heading</li>
            <li><kbd>C</kbd>: Center map on origin</li>
            <li><kbd>?</kbd>: Open this help</li>
          </ul>
        </div>
      </form>
    </dialog>

	    <datalist id="catalog-tags"></datalist>
	    <datalist id="catalog-locations"></datalist>
	    <datalist id="tdx-cities"></datalist>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
      crossorigin=""
    />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" crossorigin=""></script>
    <script src="/static/app.js"></script>
  </body>
</html>
